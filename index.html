<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Elektrické hlásenie – 5 pacientov (kompakt) FINÁL v1.13.2</title>

<style>
  :root{
    --bg:#0b1220;
    --card:#0f172a;
    --border:#22314a;
    --text:#e5e7eb;
    --muted:#94a3b8;
    --primary:#60a5fa;
    --danger:#dc2626;
    --shadow:0 10px 24px rgba(0,0,0,.35);
    --radius:16px;
    --ok:#22c55e;
    --warn:#f59e0b;
  }

  *{box-sizing:border-box;}
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,Helvetica,sans-serif;
    background:var(--bg);
    color:var(--text);
  }
  header{
    position:sticky; top:0; z-index:50;
    backdrop-filter: blur(10px);
    background: color-mix(in oklab, var(--bg) 78%, transparent);
    border-bottom:1px solid var(--border);
  }
  .wrap{max-width:1020px; margin:0 auto; padding:14px 14px 28px;}
  .top{
    display:flex; gap:10px; flex-wrap:wrap;
    align-items:center; justify-content:space-between;
  }
  h1{font-size:18px; margin:0;}
  .subtitle{font-size:12px; color:var(--muted); margin-top:4px;}
  .btnrow{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}

  button{
    border:1px solid var(--border);
    background:var(--card);
    color:var(--text);
    padding:10px 12px;
    border-radius:12px;
    font-size:13px;
    cursor:pointer;
    -webkit-tap-highlight-color: transparent;
    box-shadow: 0 4px 12px rgba(0,0,0,.10);
  }
  button.primary{
    background:var(--primary);
    color:#071022;
    border-color: color-mix(in oklab, var(--primary) 70%, var(--border));
    font-weight:700;
  }
  button.danger{
    background: color-mix(in oklab, var(--danger) 12%, var(--card));
    border-color: color-mix(in oklab, var(--danger) 50%, var(--border));
  }
  button.mini{
    padding:7px 10px;
    font-size:12px;
    border-radius:999px;
    box-shadow:none;
  }
  button.ok{
    background: color-mix(in oklab, var(--ok) 18%, var(--card));
    border-color: color-mix(in oklab, var(--ok) 50%, var(--border));
  }

  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    overflow:hidden;
    margin-top:12px;
  }
  .cardhead{
    padding:12px 14px;
    display:flex;
    justify-content:space-between;
    gap:10px;
    align-items:center;
    border-bottom:1px solid var(--border);
  }
  .cardhead b{font-size:14px;}
  .content{padding:12px 14px 14px;}

  label{
    display:block;
    font-size:12px;
    color:var(--muted);
    margin-bottom:6px;
  }
  input, textarea, select{
    width:100%;
    border:1px solid var(--border);
    background: color-mix(in oklab, var(--card) 92%, var(--bg));
    color:var(--text);
    padding:10px 10px;
    border-radius:12px;
    outline:none;
    font-size:14px;
  }
  textarea{min-height:60px; resize:vertical;}

  .row{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
    margin-bottom:10px;
  }
  @media (max-width: 740px){
    .row{grid-template-columns: 1fr;}
  }

  .mini4{
    display:grid;
    grid-template-columns: repeat(4,1fr);
    gap:10px;
    margin-bottom:10px;
  }
  @media (max-width: 740px){
    .mini4{grid-template-columns: repeat(2,1fr);}
  }

  .checks{
    display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    padding:8px 10px;
    border:1px solid var(--border);
    border-radius:12px;
    background: color-mix(in oklab, var(--card) 92%, var(--bg));
  }
  .checks label{
    margin:0;
    display:flex; align-items:center; gap:8px;
    font-size:13px;
    color:var(--text);
  }
  .checks input{width:auto;}

  .inlineTools{
    display:flex; gap:6px; flex-wrap:wrap;
    margin-top:6px;
  }

  .subBlock{
    border:1px dashed color-mix(in oklab, var(--border) 70%, transparent);
    border-radius:14px;
    padding:10px;
    margin-bottom:10px;
    background: color-mix(in oklab, var(--card) 88%, var(--bg));
  }

  .hidden{display:none !important;}

  .hint{
    color:var(--muted);
    font-size:12px;
  }

  .badge{
    display:inline-block;
    padding:2px 8px;
    border-radius:999px;
    font-size:11px;
    border:1px solid var(--border);
    color:var(--muted);
  }
</style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Kompaktné hlásenie (5 pacientov) FINÁL v1.13.2</h1>
        <div class="subtitle">
          dnes mal: / zajtra: • AA pod menom • NP ak prijatý dnes • Prepustený/Preložený na konci
        </div>
      </div>
      <div class="btnrow">
        <button class="primary" onclick="printFilledIOS()">Tlač / PDF (len vyplnené)</button>
        <button onclick="exportJSON()">Export JSON</button>
        <button onclick="document.getElementById('fileImport').click()">Import JSON</button>
        <button class="danger" onclick="resetAll()">Vymazať všetko</button>
      </div>
    </div>
    <input id="fileImport" type="file" accept="application/json" class="hidden" />
  </div>
</header>

<main class="wrap">
  <div class="card">
    <div class="cardhead"><b>Hlavička služby</b></div>
    <div class="content">

      <div class="row">
        <div>
          <label>Služba</label>
          <select id="shiftType">
            <option value="celodenna">Celodenné hlásenie</option>
            <option value="nocna">Nočné hlásenie</option>
          </select>
        </div>
        <div>
          <label>Sestra</label>
          <input id="nurseName" type="text" placeholder="meno sestry" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Dátum (stačí deň)</label>
          <input id="handoverDay" type="date" />
          <div class="inlineTools">
            <button class="mini" onclick="setHeaderDay('today')">Dnes</button>
            <button class="mini" onclick="setHeaderDay('tomorrow')">Zajtra</button>
          </div>
        </div>
        <div class="hint">
          Tlač bude bez času. (Dátum a čas v hlásení pacientov riešia len vyšetrenia/odbery.)
        </div>
      </div>

    </div>
  </div>

  <div class="card">
    <div class="cardhead">
      <b>Odídení (prepustený / preložený)</b>
      <span class="badge" id="leftCount">0</span>
    </div>
    <div class="content">
      <div class="hint">Sem sa odložia pacienti po kliknutí na tlačidlo „Uložiť ako odídený“. Do tlače pôjdu na konci.</div>
      <div id="leftList" style="margin-top:10px;"></div>
    </div>
  </div>

  <div id="patients"></div>
</main>

<script>
  const STORAGE_KEY = "KOMPAKT_HLASENIE_5PAC_FINAL_V1132";

  function pad(n){ return String(n).padStart(2,'0'); }

  function todayISO(){
    const d = new Date();
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }

  function isoAddDays(iso, add){
    const d = new Date(iso + "T00:00:00");
    d.setDate(d.getDate() + add);
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }

  function cleanSpaces(s){ return String(s||"").replace(/\s+/g," ").trim(); }

  function escapeHTML(str){
    return String(str)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }

  function formatDateSK(iso){
    if(!iso) return "";
    const d = iso.split("-");
    return `${d[2]}.${d[1]}.${d[0]}`.trim();
  }

  function isTomorrow(dateISO){
    if(!dateISO) return false;
    return dateISO === isoAddDays(todayISO(), 1);
  }

  function isToday(dateISO){
    if(!dateISO) return false;
    return dateISO === todayISO();
  }

  function timeToMinutes(t){
    if(!t) return null;
    const m = String(t).match(/^(\d{1,2}):(\d{2})$/);
    if(!m) return null;
    return parseInt(m[1],10)*60 + parseInt(m[2],10);
  }

  function setHeaderDay(which){
    let d = todayISO();
    if(which === "tomorrow") d = isoAddDays(todayISO(),1);
    document.getElementById("handoverDay").value = d;
    save();
  }

  function defaultHeaderDay(){
    document.getElementById("handoverDay").value = todayISO();
  }

  // ------- Rendering pacienta -------

  function patientTemplate(i){
    return `
    <section class="card patientCard" id="patient_${i}">
      <div class="cardhead">
        <b>Pacient ${i}</b>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="ok" onclick="finishPatient(${i})">Uložiť ako odídený</button>
          <button onclick="clearPatient(${i})">Vymazať</button>
        </div>
      </div>

      <div class="content">

        <div class="mini4">
          <div><label>Izba/lôžko</label><input data-k="p${i}_bed" type="text" placeholder="4/1" /></div>
          <div><label>Priezvisko</label><input data-k="p${i}_surname" type="text" placeholder="Novák" /></div>
          <div><label>Meno</label><input data-k="p${i}_name" type="text" placeholder="Ján" /></div>
          <div>
            <label>PR</label>
            <select data-k="p${i}_pr">
              <option value="">-</option>
              <option value="A">A</option>
              <option value="A+WC">A+WC</option>
              <option value="B">B</option>
              <option value="C">C</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>AA: (alergia)</label>
            <input data-k="p${i}_allergy" type="text" placeholder="napr. Penicilín" />
          </div>
          <div>
            <label>Dátum prijatia</label>
            <input data-k="p${i}_admit_date" type="date" />
            <div class="inlineTools">
              <button class="mini" onclick="setDate('p${i}_admit_date','today')">Dnes</button>
              <button class="mini" onclick="setDate('p${i}_admit_date','yesterday')">Včera</button>
            </div>
          </div>
        </div>

        <div class="subBlock">
          <div class="row">
            <div>
              <label>EKG</label>
              <input data-k="p${i}_ekg" type="text" placeholder="denne / VV" />
            </div>
            <div>
              <label>TK</label>
              <input data-k="p${i}_tk" type="text" placeholder="napr. šoková / 3x / TK šoková" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Monitorovať</label>
              <div class="checks">
                <label><input type="checkbox" data-k="p${i}_mon_check" /> monitorovať</label>
              </div>
            </div>
            <div>
              <label>Bilancia</label>
              <div class="checks">
                <label><input type="checkbox" data-k="p${i}_pv_check" /> P+V</label>
              </div>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Lieky (stručne)</label>
              <input data-k="p${i}_drugs" type="text" placeholder="napr. ASA, Betaloc..." />
            </div>
            <div>
              <label>Voľný text</label>
              <input data-k="p${i}_note" type="text" placeholder="ďalšie info..." />
            </div>
          </div>
        </div>

        <div class="subBlock">
          <div class="row">
            <div>
              <label>MM (odklik + hodnota)</label>
              <div class="checks">
                <label><input type="checkbox" data-k="p${i}_mm_on" /> MM</label>
              </div>
              <div id="mm_box_${i}" class="hidden" style="margin-top:8px;">
                <label>Hodnota</label>
                <input data-k="p${i}_mm_value" type="text" placeholder="napr. 60 ml/2 hod." />
              </div>
            </div>

            <div>
              <label>KS (výber)</label>
              <select data-k="p${i}_ks_type">
                <option value="">Nemá</option>
                <option value="TKS">TKS</option>
                <option value="DKS">DKS</option>
                <option value="ICD">ICD</option>
                <option value="REVEAL">REVEAL</option>
              </select>
              <div id="ks_date_box_${i}" class="hidden" style="margin-top:8px;">
                <label>Dátum zavedenia (DKS povinné)</label>
                <input data-k="p${i}_ks_date" type="date" />
                <div class="inlineTools">
                  <button class="mini" onclick="setDate('p${i}_ks_date','today')">Dnes</button>
                  <button class="mini" onclick="setDate('p${i}_ks_date','yesterday')">Včera</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ✅ PK blok -->
        <div class="subBlock">
          <div class="row">
            <div>
              <label>PK (odklik → dátum)</label>
              <div class="checks">
                <label><input type="checkbox" data-k="p${i}_pk_on" /> PK</label>
              </div>

              <div id="pk_box_${i}" class="hidden" style="margin-top:8px;">
                <label>Dátum zavedenia</label>
                <input data-k="p${i}_pk_date" type="date" />
                <div class="inlineTools">
                  <button class="mini" onclick="setDate('p${i}_pk_date','today')">Dnes</button>
                  <button class="mini" onclick="setDate('p${i}_pk_date','yesterday')">Včera</button>
                </div>
              </div>
            </div>

            <div class="hint">
              PK sa tlačí ako: <b>PK 1. deň</b> / <b>PK 2. deň</b> …
            </div>
          </div>
        </div>

        <div class="subBlock">
          <label>Hladina lieku</label>
          <div class="row">
            <div>
              <label>Názov</label>
              <input data-k="p${i}_lvl_name" type="text" placeholder="napr. Tacrolimus" />
            </div>
            <div>
              <label>Dátum</label>
              <input data-k="p${i}_lvl_date" type="date" />
              <div class="inlineTools">
                <button class="mini" onclick="setDate('p${i}_lvl_date','today')">Dnes</button>
                <button class="mini" onclick="setDate('p${i}_lvl_date','tomorrow')">Zajtra</button>
              </div>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Čas (nepovinné)</label>
              <input data-k="p${i}_lvl_time" type="time" />
            </div>
            <div>
              <label>Typ</label>
              <div class="checks">
                <label><input type="checkbox" data-k="p${i}_lvl_obe" /> obe</label>
              </div>
              <div class="hint" style="margin-top:6px;">Ak nie je „obe“, tlačí sa „reziduálna“</div>
            </div>
          </div>
        </div>

        <div class="subBlock">
          <label>Odbery</label>
          <div class="row">
            <div>
              <div class="checks">
                <label><input type="checkbox" data-k="p${i}_lab_odbery" /> odbery</label>
                <label><input type="checkbox" data-k="p${i}_lab_vytery" /> výtery</label>
                <label><input type="checkbox" data-k="p${i}_lab_moc" /> moč K+C</label>
                <label><input type="checkbox" data-k="p${i}_lab_antigeny" /> antigény</label>
              </div>
              <div style="margin-top:8px;">
                <label>Poznámka</label>
                <input data-k="p${i}_lab_note" type="text" placeholder="napr. MRSA/EBV..." />
              </div>
            </div>

            <div>
              <label>Dátum</label>
              <input data-k="p${i}_lab_date" type="date" />
              <div class="inlineTools">
                <button class="mini" onclick="setDate('p${i}_lab_date','today')">Dnes</button>
                <button class="mini" onclick="setDate('p${i}_lab_date','tomorrow')">Zajtra</button>
              </div>

              <div style="margin-top:8px;">
                <label>Čas</label>
                <input data-k="p${i}_lab_time" type="time" />
              </div>
            </div>
          </div>
        </div>

        <div class="subBlock">
          <label>Hemokultúry</label>
          <div class="row">
            <div>
              <div class="checks">
                <label><input type="checkbox" data-k="p${i}_hk_obe" /> obe</label>
              </div>
              <div class="inlineTools" style="margin-top:8px;">
                <button class="primary mini" onclick="addHK(${i})">+ HK</button>
                <button class="mini" onclick="clearHK(${i})">Vymazať HK</button>
              </div>
              <div class="hint" style="margin-top:8px;">Klikni max 3× za deň. Tlač: HK3xobe</div>
            </div>

            <div>
              <label>Dátum</label>
              <input data-k="p${i}_hk_date" type="date" />
              <div class="inlineTools">
                <button class="mini" onclick="setDate('p${i}_hk_date','today')">Dnes</button>
                <button class="mini" onclick="setDate('p${i}_hk_date','tomorrow')">Zajtra</button>
              </div>

              <div style="margin-top:8px;">
                <label>Čas</label>
                <input data-k="p${i}_hk_time" type="time" />
              </div>
            </div>
          </div>

          <div id="hk_list_${i}" class="hint"></div>
        </div>

        <div class="subBlock">
          <label>Krvné prípravky</label>

          <div class="row">
            <div>
              <label>Typ</label>
              <select data-k="p${i}_blood_type">
                <option value="">-</option>
                <option value="TUEM">TUEM</option>
                <option value="ČMP">ČMP</option>
                <option value="TK">trombokoncentrát</option>
              </select>
            </div>
            <div>
              <label>Objednané (ks)</label>
              <input data-k="p${i}_blood_ordered" type="number" min="0" step="1" placeholder="0" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Pripravené (ks)</label>
              <input data-k="p${i}_blood_ready" type="number" min="0" step="1" placeholder="0" />
            </div>
            <div>
              <label>Zaistené (ks)</label>
              <input data-k="p${i}_blood_secured" type="number" min="0" step="1" placeholder="0" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Kedy podať (dátum)</label>
              <input data-k="p${i}_blood_date" type="date" />
              <div class="inlineTools">
                <button class="mini" onclick="setDate('p${i}_blood_date','today')">Dnes</button>
                <button class="mini" onclick="setDate('p${i}_blood_date','tomorrow')">Zajtra</button>
              </div>
            </div>
            <div>
              <label>Kedy podať (čas)</label>
              <input data-k="p${i}_blood_time" type="time" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Podané</label>
              <div class="checks">
                <label><input type="checkbox" data-k="p${i}_blood_given" /> podané</label>
              </div>
              <div class="hint" style="margin-top:6px;">
                Ak označíš „podané“, odpočíta sa z „pripravené“. Keď je 0 → nič nerobí.
              </div>
            </div>
            <div></div>
          </div>
        </div>

        <div class="subBlock">
          <label>Plánované vyšetrenia (1–3)</label>

          ${examBlock(i,1)}
          ${examBlock(i,2)}
          ${examBlock(i,3)}

          <div class="row">
            <div>
              <label>Plán (voľný text)</label>
              <textarea data-k="p${i}_planned"></textarea>
            </div>
            <div>
              <label>Absolvované (voľný text)</label>
              <textarea data-k="p${i}_done"></textarea>
            </div>
          </div>
        </div>

        <div class="subBlock">
          <label>Ukončenie</label>
          <div class="row">
            <div>
              <div class="checks">
                <label><input type="checkbox" data-k="p${i}_discharged" /> prepustený</label>
                <label><input type="checkbox" data-k="p${i}_transferred" /> preložený</label>
              </div>
              <div style="margin-top:8px;">
                <label>Kam (pri preložení)</label>
                <input data-k="p${i}_transfer_where" type="text" placeholder="napr. KOCH / OAIM / ..."/>
              </div>
            </div>

            <div class="hint">
              Vyplňte, či je prepustený alebo preložený. Keď budete mať všetko hotové, kliknite hore na tlačidlo <b>"Uložiť ako odídený"</b>. Tým sa formulár vymaže pre nového pacienta.
            </div>
          </div>
        </div>

      </div>
    </section>`;
  }

  function examBlock(i, n){
    return `
      <div class="row">
        <div>
          <label>Vyšetrenie ${n}</label>
          <input data-k="p${i}_exam${n}_text" type="text" placeholder="napr. ECHO" />
        </div>
        <div>
          <label>Dátum</label>
          <input data-k="p${i}_exam${n}_date" type="date" />
          <div class="inlineTools">
            <button class="mini" onclick="setDate('p${i}_exam${n}_date','today')">Dnes</button>
            <button class="mini" onclick="setDate('p${i}_exam${n}_date','tomorrow')">Zajtra</button>
          </div>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Čas (nepovinné)</label>
          <input data-k="p${i}_exam${n}_time" type="time" />
        </div>
        <div></div>
      </div>
    `;
  }

  function render(){
    const root = document.getElementById("patients");
    root.innerHTML = "";
    for(let i=1;i<=5;i++){
      root.insertAdjacentHTML("beforeend", patientTemplate(i));
    }
  }

  // ------- Data helpers -------

  function getVal(k){
    const el = document.querySelector(`[data-k="${k}"]`);
    if(!el) return "";
    if(el.type === "checkbox") return el.checked ? "1" : "";
    return el.value ?? "";
  }

  function setVal(k, v){
    const el = document.querySelector(`[data-k="${k}"]`);
    if(!el) return;
    if(el.type === "checkbox") el.checked = !!v;
    else el.value = v ?? "";
  }

  function getHKKey(i){ return `p${i}`; }

  function getState(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return null;
    try{ return JSON.parse(raw); }catch(e){ return null; }
  }

  function ensureState(){
    let st = getState();
    if(!st){
      st = { meta:{}, fields:{}, left:[], hk:{} };
    }
    if(!st.meta) st.meta = {};
    if(!st.fields) st.fields = {};
    if(!st.left) st.left = [];
    if(!st.hk) st.hk = {};
    return st;
  }

  function save(){
    const data = ensureState();

    data.meta.shiftType = document.getElementById("shiftType")?.value || "celodenna";
    data.meta.handoverDay = document.getElementById("handoverDay")?.value || todayISO();
    data.meta.nurseName = document.getElementById("nurseName")?.value || "";
    data.meta.savedAt = new Date().toISOString();

    document.querySelectorAll("[data-k]").forEach(el=>{
      const k = el.getAttribute("data-k");
      if(el.type === "checkbox") data.fields[k] = el.checked ? 1 : 0;
      else data.fields[k] = el.value ?? "";
    });

    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    renderLeftList();
    renderHKLists();
  }

  function load(){
    const st = getState();
    if(!st){
      document.getElementById("shiftType").value = "celodenna";
      document.getElementById("nurseName").value = "";
      defaultHeaderDay();
      return;
    }

    document.getElementById("shiftType").value = st.meta?.shiftType || "celodenna";
    document.getElementById("handoverDay").value = st.meta?.handoverDay || todayISO();
    document.getElementById("nurseName").value = st.meta?.nurseName || "";

    document.querySelectorAll("[data-k]").forEach(el=>{
      const k = el.getAttribute("data-k");
      if(!(k in (st.fields||{}))) return;
      if(el.type === "checkbox") el.checked = !!st.fields[k];
      else el.value = st.fields[k] ?? "";
    });

    syncAllDynamic();
    renderLeftList();
    renderHKLists();
  }

  function resetAll(){
    if(!confirm("Vymazať všetko?")) return;
    localStorage.removeItem(STORAGE_KEY);
    render();
    document.getElementById("shiftType").value = "celodenna";
    document.getElementById("nurseName").value = "";
    defaultHeaderDay();
    renderLeftList();
  }

  function clearPatient(i){
    if(!confirm(`Vymazať Pacienta ${i}?`)) return;
    document.querySelectorAll(`#patient_${i} [data-k]`).forEach(el=>{
      if(el.type === "checkbox") el.checked = false;
      else el.value = "";
    });
    syncAllDynamic();
    save();
  }

  function setDate(key, which){
    let d = todayISO();
    if(which === "yesterday") d = isoAddDays(todayISO(), -1);
    if(which === "tomorrow") d = isoAddDays(todayISO(), 1);
    setVal(key, d);
    syncAllDynamic();
    save();
  }

  function syncPatient(i){
    document.getElementById(`mm_box_${i}`)?.classList.toggle("hidden", !getVal(`p${i}_mm_on`));
    document.getElementById(`pk_box_${i}`)?.classList.toggle("hidden", !getVal(`p${i}_pk_on`));

    const ksType = getVal(`p${i}_ks_type`);
    const needsDateBox = (ksType === "TKS" || ksType === "DKS" || ksType === "ICD" || ksType === "REVEAL");
    document.getElementById(`ks_date_box_${i}`)?.classList.toggle("hidden", !needsDateBox);
  }

  function syncAllDynamic(){
    for(let i=1;i<=5;i++) syncPatient(i);
  }

  // ------- Odídení -------

  function finishPatient(i){
    const discharged = !!getVal(`p${i}_discharged`);
    const transferred = !!getVal(`p${i}_transferred`);

    const bed = cleanSpaces(getVal(`p${i}_bed`));
    const surname = cleanSpaces(getVal(`p${i}_surname`));
    const name = cleanSpaces(getVal(`p${i}_name`));

    if(!(discharged || transferred)){
      alert("Najprv označ: prepustený alebo preložený ✅");
      return;
    }

    if(!(bed || surname || name)){
      alert("Doplň aspoň lôžko alebo meno pacienta.");
      return;
    }

    const moved = moveToLeftIfMarked(i, true);
    if(!moved){
      alert("Nepodarilo sa uložiť pacienta.");
    }
  }

  function moveToLeftIfMarked(i, force){
    const discharged = !!getVal(`p${i}_discharged`);
    const transferred = !!getVal(`p${i}_transferred`);

    if(!force && !(discharged || transferred)) return false;
    if(force && !(discharged || transferred)) return false;

    const bed = cleanSpaces(getVal(`p${i}_bed`));
    const surname = cleanSpaces(getVal(`p${i}_surname`));
    const name = cleanSpaces(getVal(`p${i}_name`));
    if(!(bed || surname || name)) return false;

    const st = ensureState();

    const leftItem = {
      ts: new Date().toISOString(),
      bed,
      surname,
      name,
      allergy: cleanSpaces(getVal(`p${i}_allergy`)),
      end: {
        discharged,
        transferred,
        where: cleanSpaces(getVal(`p${i}_transfer_where`))
      }
    };

    st.left.unshift(leftItem);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(st));

    document.querySelectorAll(`#patient_${i} [data-k]`).forEach(el=>{
      if(el.type === "checkbox") el.checked = false;
      else el.value = "";
    });

    syncAllDynamic();
    save();
    return true;
  }

  function renderLeftList(){
    const st = ensureState();
    const root = document.getElementById("leftList");
    const cnt = document.getElementById("leftCount");
    cnt.textContent = String((st.left||[]).length);

    if(!st.left || st.left.length === 0){
      root.innerHTML = `<div class="hint">(zatiaľ nikto)</div>`;
      return;
    }

    root.innerHTML = st.left.slice(0,15).map((x, idx)=>{
      const fullname = cleanSpaces(`${x.surname} ${x.name}`) || "-";
      const a = x.allergy ? `AA: ${x.allergy}` : "";
      const endLines = [];
      if(x.end?.discharged) endLines.push("prepustený");
      if(x.end?.transferred) endLines.push(`preložený: ${x.end?.where || "-"}`);

      return `
        <div style="padding:8px 10px; border:1px solid var(--border); border-radius:12px; margin-bottom:8px;">
          <b>${escapeHTML(x.bed || "-")}</b> ${escapeHTML(fullname)}
          ${a ? `<div class="hint">${escapeHTML(a)}</div>` : ""}
          <div class="hint">${escapeHTML(endLines.join(" | "))}</div>
          <div class="inlineTools" style="margin-top:8px;">
            <button class="mini danger" onclick="deleteLeft(${idx})">Zmazať</button>
          </div>
        </div>
      `;
    }).join("");
  }

  function deleteLeft(idx){
    const st = ensureState();
    st.left.splice(idx,1);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(st));
    renderLeftList();
  }

  // ------- HK -------

  function addHK(i){
    const st = ensureState();
    const key = getHKKey(i);
    if(!st.hk[key]) st.hk[key] = [];
    if(st.hk[key].length >= 3){
      alert("HK max 3×");
      return;
    }
    st.hk[key].push({ ts: new Date().toISOString() });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(st));
    renderHKLists();
    save();
  }

  function clearHK(i){
    const st = ensureState();
    const key = getHKKey(i);
    st.hk[key] = [];
    localStorage.setItem(STORAGE_KEY, JSON.stringify(st));
    renderHKLists();
    save();
  }

  function renderHKLists(){
    const st = ensureState();
    for(let i=1;i<=5;i++){
      const key = getHKKey(i);
      const list = st.hk[key] || [];
      const el = document.getElementById(`hk_list_${i}`);
      if(!el) continue;
      if(list.length === 0) el.innerHTML = "";
      else el.innerHTML = `HK kliknuté: ${list.length}×`;
    }
  }

  // ------- Print composing -------

  function addComma(parts, piece){
    const t = cleanSpaces(piece);
    if(!t) return;
    parts.push(t);
  }

  function ksPrint(ksType, ksDate){
    if(!ksType) return "";

    if(ksType === "DKS"){
      if(!ksDate) return "";
      const day = makeDayTextFromDate(ksDate);
      return day ? `DKS ${day}` : "DKS";
    }

    if(!ksDate) return `${ksType} dlhodobo`;

    const day = makeDayTextFromDate(ksDate);
    return day ? `${ksType} ${day}` : `${ksType} dlhodobo`;
  }

  function examPrint(label, dateISO, timeStr){
    const lab = cleanSpaces(label);
    const d = cleanSpaces(dateISO);
    const t = cleanSpaces(timeStr);

    if(!lab) return "";

    if(d && isToday(d)){
      return `dnes mal: ${lab}`.trim();
    }

    if(d && isTomorrow(d)){
      if(t) return `zajtra: ${t} ${lab}`.trim();
      return `zajtra: ${lab}`.trim();
    }

    if(t) return `${t} ${lab}`.trim();
    return lab;
  }

  function levelPrint(name, dateISO, timeStr, obe){
    const n = cleanSpaces(name);
    const d = cleanSpaces(dateISO);
    const t = cleanSpaces(timeStr);

    if(!n) return "";

    const typ = obe ? "obe" : "reziduálna";

    if(d && isToday(d)){
      return `dnes mal: hladina ${n} ${typ}`.trim();
    }

    if(d && isTomorrow(d)){
      if(t) return `zajtra: ${t} hladina ${n} ${typ}`.trim();
      return `zajtra: hladina ${n} ${typ}`.trim();
    }

    if(t) return `${t} hladina ${n} ${typ}`.trim();
    return `hladina ${n} ${typ}`.trim();
  }

  function labsPrint(i){
    const any = (
      getVal(`p${i}_lab_odbery`) ||
      getVal(`p${i}_lab_vytery`) ||
      getVal(`p${i}_lab_moc`) ||
      getVal(`p${i}_lab_antigeny`)
    );

    const note = cleanSpaces(getVal(`p${i}_lab_note`));
    const d = cleanSpaces(getVal(`p${i}_lab_date`));
    const t = cleanSpaces(getVal(`p${i}_lab_time`));

    if(!any && !note) return "";

    const items = [];
    if(getVal(`p${i}_lab_odbery`)) items.push("odbery");
    if(getVal(`p${i}_lab_vytery`)) items.push("výtery");
    if(getVal(`p${i}_lab_moc`)) items.push("moč K+C");
    if(getVal(`p${i}_lab_antigeny`)) items.push("antigény");

    let base = items.join(", ");
    if(note) base = base ? `${base} ${note}` : note;

    const shiftType = document.getElementById("shiftType")?.value || "celodenna";
    const minutes = timeToMinutes(t);

    if(shiftType === "nocna"){
      if(d && isToday(d)){
        if(minutes !== null && minutes >= 360){
          return `dnes ${base}`.trim();
        }
        return base;
      }
      if(d && isTomorrow(d)){
        return `zajtra ${base}`.trim();
      }
      return base;
    }

    if(d && isTomorrow(d)){
      if(minutes !== null && minutes < 360){
        return `zajtra odbery nočná ${base}`.trim();
      }
      return `zajtra ${base}`.trim();
    }

    return base;
  }

  function hkPrint(i){
    const st = ensureState();
    const key = getHKKey(i);
    const count = (st.hk[key] || []).length;
    if(!count) return "";

    const obe = !!getVal(`p${i}_hk_obe`);
    if(obe) return `HK${count}xobe`;
    return `HK${count}x`;
  }

  function bloodPrint(i){
    const type = cleanSpaces(getVal(`p${i}_blood_type`));
    const ordered = parseInt(getVal(`p${i}_blood_ordered`) || "0", 10) || 0;
    const ready = parseInt(getVal(`p${i}_blood_ready`) || "0", 10) || 0;
    const secured = parseInt(getVal(`p${i}_blood_secured`) || "0", 10) || 0;
    const d = cleanSpaces(getVal(`p${i}_blood_date`));
    const t = cleanSpaces(getVal(`p${i}_blood_time`));

    if(!type) return "";
    if(ordered === 0 && ready === 0 && secured === 0) return "";

    let line = `${ordered}${type}`;
    if(ready > 0) line += ` pripravené ${ready}`;
    if(secured > 0) line += ` zaistené ${secured}`;

    if(d && isTomorrow(d)){
      if(t) line = `zajtra: ${t} ${line}`;
      else line = `zajtra: ${line}`;
    }else if(d && isToday(d)){
      if(t) line = `dnes: ${t} ${line}`;
      else line = `dnes: ${line}`;
    }else{
      if(t) line = `${t} ${line}`;
    }

    return line.trim();
  }

  function makeDayTextFromDate(startISO){
    if(!startISO) return "";
    const start = new Date(startISO + "T00:00:00");
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const diffDays = Math.floor((today - start) / (1000*60*60*24));
    const d = diffDays + 1;
    if(d < 1) return "";
    return `${d}. deň`;
  }

  function buildPrintRowsSorted(){
    const items = [];
    for(let i=1;i<=5;i++){
      const bed = cleanSpaces(getVal(`p${i}_bed`));
      const sur = cleanSpaces(getVal(`p${i}_surname`));
      const nam = cleanSpaces(getVal(`p${i}_name`));
      if(!(bed || sur || nam)) continue;
      items.push({i, bed});
    }

    const parseBed = (s)=>{
      const m = String(s||"").match(/^\s*(\d+)\s*\/\s*(\d+)\s*$/);
      if(!m) return {room:9999, bed:9999};
      return {room: parseInt(m[1],10), bed: parseInt(m[2],10)};
    };

    items.sort((a,b)=>{
      const A = parseBed(a.bed);
      const B = parseBed(b.bed);
      if(A.room !== B.room) return A.room - B.room;
      if(A.bed !== B.bed) return A.bed - B.bed;
      return a.i - b.i;
    });

    return items.map(({i})=>{
      const bed = cleanSpaces(getVal(`p${i}_bed`)) || "-";
      const fullname = cleanSpaces((getVal(`p${i}_surname`) + " " + getVal(`p${i}_name`)).trim()) || "-";
      const allergy = cleanSpaces(getVal(`p${i}_allergy`));

      const parts = [];

      const admit = cleanSpaces(getVal(`p${i}_admit_date`));
      if(admit && isToday(admit)) addComma(parts, "NP");

      const pr = cleanSpaces(getVal(`p${i}_pr`));
      if(pr) addComma(parts, `"${pr}"`);

      const ekg = cleanSpaces(getVal(`p${i}_ekg`));
      if(ekg) addComma(parts, `EKG ${ekg}`);

      if(getVal(`p${i}_mon_check`)) addComma(parts, "monitorovať");

      const tk = cleanSpaces(getVal(`p${i}_tk`));
      if(tk) addComma(parts, `TK ${tk}`);

      if(getVal(`p${i}_pv_check`)) addComma(parts, "P+V");

      if(getVal(`p${i}_pk_on`)){
        const d = cleanSpaces(getVal(`p${i}_pk_date`));
        const day = makeDayTextFromDate(d);
        addComma(parts, day ? `PK ${day}` : "PK");
      }

      if(getVal(`p${i}_mm_on`)){
        const mmv = cleanSpaces(getVal(`p${i}_mm_value`));
        if(mmv) addComma(parts, `MM: ${mmv}`);
      }

      const ksType = cleanSpaces(getVal(`p${i}_ks_type`));
      const ksDate = cleanSpaces(getVal(`p${i}_ks_date`));
      const ksText = cleanSpaces(ksPrint(ksType, ksDate));
      if(ksText) addComma(parts, ksText);

      const lvl = levelPrint(
        getVal(`p${i}_lvl_name`),
        getVal(`p${i}_lvl_date`),
        getVal(`p${i}_lvl_time`),
        !!getVal(`p${i}_lvl_obe`)
      );
      if(lvl) addComma(parts, lvl);

      const drugs = cleanSpaces(getVal(`p${i}_drugs`));
      if(drugs) addComma(parts, drugs);

      const labs = cleanSpaces(labsPrint(i));
      if(labs) addComma(parts, labs);

      const hk = cleanSpaces(hkPrint(i));
      if(hk) addComma(parts, hk);

      const bl = cleanSpaces(bloodPrint(i));
      if(bl) addComma(parts, bl);

      for(let n=1;n<=3;n++){
        const ex = examPrint(
          getVal(`p${i}_exam${n}_text`),
          getVal(`p${i}_exam${n}_date`),
          getVal(`p${i}_exam${n}_time`)
        );
        if(ex) addComma(parts, ex);
      }

      const planned = cleanSpaces(getVal(`p${i}_planned`));
      if(planned) addComma(parts, planned);

      const done = cleanSpaces(getVal(`p${i}_done`));
      if(done) addComma(parts, done);

      const note = cleanSpaces(getVal(`p${i}_note`));
      if(note) addComma(parts, note);

      const discharged = !!getVal(`p${i}_discharged`);
      const transferred = !!getVal(`p${i}_transferred`);
      const where = cleanSpaces(getVal(`p${i}_transfer_where`));

      let endBlock = "";
      const endLines = [];
      if(discharged) endLines.push("prepustený");
      if(transferred) endLines.push(`preložený: ${where || "-"}`);
      if(endLines.length) endBlock = "\n" + endLines.join("\n");

      return { bed, fullname, allergy, third: parts.join(", ") + endBlock };
    });
  }

  function buildLeftRowsForPrint(){
    const st = ensureState();
    const left = st.left || [];

    const parseBed = (s)=>{
      const m = String(s||"").match(/^\s*(\d+)\s*\/\s*(\d+)\s*$/);
      if(!m) return {room:9999, bed:9999};
      return {room: parseInt(m[1],10), bed: parseInt(m[2],10)};
    };

    const sorted = [...left].sort((a,b)=>{
      const A = parseBed(a.bed);
      const B = parseBed(b.bed);
      if(A.room !== B.room) return A.room - B.room;
      if(A.bed !== B.bed) return A.bed - B.bed;
      return 0;
    });

    return sorted.map(x=>{
      const bed = x.bed || "-";
      const fullname = cleanSpaces(`${x.surname||""} ${x.name||""}`) || "-";
      const allergy = x.allergy || "";

      const endLines = [];
      if(x.end?.discharged) endLines.push("prepustený");
      if(x.end?.transferred) endLines.push(`preložený: ${x.end?.where || "-"}`);

      return { bed, fullname, allergy, third: endLines.join("\n") };
    });
  }

  function buildPrintHTML(){
    const shiftType = document.getElementById("shiftType")?.value || "celodenna";
    const shiftLabel = (shiftType === "nocna") ? "Nočné hlásenie" : "Celodenné hlásenie";

    const dayISO = document.getElementById("handoverDay")?.value || todayISO();
    const dayText = formatDateSK(dayISO);

    const nurse = document.getElementById("nurseName").value || "-";

    const activeRows = buildPrintRowsSorted();
    const leftRows = buildLeftRowsForPrint();

    let rowsHTML = "";
    const allRows = [...activeRows, ...(leftRows.length ? [{sep:true}] : []), ...leftRows];

    for(const r of allRows){
      if(r.sep){
        rowsHTML += `
          <div style="margin:10px 0; border-top:2px solid #999;"></div>
          <div style="font-size:12px; margin-bottom:6px;"><b>Odídení</b></div>
        `;
        continue;
      }

      rowsHTML += `
        <div class="r">
          <div class="c1">${escapeHTML(r.bed)}</div>
          <div class="c2">
            <div class="nm">${escapeHTML(r.fullname)}</div>
            ${r.allergy ? `<div class="aa">AA: ${escapeHTML(r.allergy)}</div>` : ``}
          </div>
          <div class="c3">${escapeHTML(r.third || "").replace(/\n/g,"<br>")}</div>
        </div>
      `;
    }

    if(!rowsHTML){
      rowsHTML = `<div>(Žiadny pacient nie je vyplnený.)</div>`;
    }

    return `
      <!doctype html>
      <html><head>
      <meta charset="utf-8"/>
      <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
      <title>Tlač</title>
      <style>
        body{
          font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", "Segoe UI", Roboto, Arial, sans-serif;
          margin:0; padding:0;
          font-size:13px;
          line-height:1.35;
          letter-spacing:0.1px;
          color:#111;
        }
        @page { margin: 8mm; }

        .head{
          font-size:14px;
          margin-bottom:10px;
          font-weight:700;
        }

        .r{
          display:grid;
          grid-template-columns: 62px 200px 1fr;
          gap:10px;
          padding:6px 0;
          border-bottom:1px solid #ddd;
          align-items:start;
        }

        .c1{white-space:nowrap; font-weight:700;}
        .c2{white-space:normal;}
        .nm{white-space:nowrap; font-weight:700;}
        .aa{font-size:12px; margin-top:2px;}
        .c3{white-space:normal; word-break:break-word;}
      </style>
      </head><body>
        <div class="head">${escapeHTML(shiftLabel)} – ${escapeHTML(dayText)}, sestra: ${escapeHTML(nurse)}</div>
        ${rowsHTML}
        <script>window.onload=()=>window.print();<\/script>
      </body></html>
    `;
  }

  function printFilledIOS(){
    save();
    const html = buildPrintHTML();
    const w = window.open("", "_blank");
    if(!w){
      alert("iOS blokuje nové okno (pop-up). Povoľ pop-ups v Safari.");
      return;
    }
    w.document.open();
    w.document.write(html);
    w.document.close();
  }

  function exportJSON(){
    save();
    const raw = localStorage.getItem(STORAGE_KEY) || "{}";
    const blob = new Blob([raw], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "Hlasenie_5pac_FINAL_v1132.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  }

  function handleBloodGivenAuto(i){
    const givenKey = `p${i}_blood_given`;
    if(!getVal(givenKey)) return;

    const readyKey = `p${i}_blood_ready`;
    let ready = parseInt(getVal(readyKey) || "0",10) || 0;

    if(ready <= 0){
      setVal(givenKey, "");
      return;
    }

    ready = ready - 1;
    setVal(readyKey, String(ready));
    setVal(givenKey, "");
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    render();
    defaultHeaderDay();
    load();

    document.addEventListener("change", (e)=>{
      if(e.target && e.target.matches("[data-k], #handoverDay, #nurseName, #shiftType")){
        for(let i=1;i<=5;i++){
          handleBloodGivenAuto(i);
        }
        syncAllDynamic();
        save();
      }
    });

    document.addEventListener("input", (e)=>{
      if(e.target && e.target.matches("[data-k], #handoverDay, #nurseName")){
        save();
      }
    });

    document.getElementById("fileImport").addEventListener("change", async (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      try{
        const text = await file.text();
        const data = JSON.parse(text);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        load();
        alert("Import hotový ✅");
      }catch(err){
        alert("Import zlyhal ❌");
      }finally{
        e.target.value = "";
      }
    });

    syncAllDynamic();
    save();
  });
</script>

</body>
</html>